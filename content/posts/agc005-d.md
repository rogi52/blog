+++
date = '2026-01-21T22:56:00+09:00'
draft = false
title = 'AGC005-D ~K Perm Counting $O(N \log N)$ 時間解法'
math = true
toc = true
+++

- [概要](#概要)
- [内容](#内容)
  - [パスグラフ単体](#パスグラフ単体)
  - [グラフ全体](#グラフ全体)
  - [計算量](#計算量)
- [類題](#類題)
- [感想](#感想)

## 概要
[AGC005 D ~K Perm Counting](https://atcoder.jp/contests/agc005/tasks/agc005_d)
を $O(N \log N)$ 時間で解く方法を解説します．
公式解説で「おまけ」として言及されている解法です．


## 内容
公式解説と同様に，問題を「$2N$ 個の頂点からなる二部グラフのマッチング問題」として整理します．
グラフの各連結成分はパスグラフになります．
したがって，問題は「パスグラフの集合から合計 $A$ 本の辺を，マッチングとなる (端点を共有しない) ように選ぶ方法の数」を $A = 0, 1, \dots, N$ について求めることに帰着されます．


### パスグラフ単体
頂点数 $n$ のパスグラフにおいて，マッチングとなるように $i$ 本の辺を選ぶ方法の数を考えます．
隣り合う辺は端点を共有するため， $(n-1)$ 本の辺から $i$ 本の辺を「連続しないように」選ぶ方法の数と等しくなります．

$1$ 列に並んだ $(n-1)$ 個の玉から，連続しないように $i$ 個選ぶ方法は，
「選ばない $(n-1-i)$ 個の玉を並べ，その隙間と両端の計 $(n-i)$ 箇所から，選ぶ玉を置く $i$ 箇所を選ぶ」と考えれば，その総数は $\binom{n-i}{i}$ 通りです．
これを母関数として表すと次のようになります．
$$ F_n(x) \coloneqq \sum_i \binom{n-i}{i}  x^i $$


### グラフ全体
パスグラフの頂点数としてあり得るのは，$\left\lfloor \frac{N}{K} \right\rfloor$ または $\left\lceil \frac{N}{K} \right\rceil$ です．
これらを $n_1, n_2$ とし，それぞれのパスグラフの個数を $c_1, c_2$ とします
（$N$ が $K$ で割り切れるときは，例えば $c_1 = 2K$，$c_2 = 0$ とすれば良いです）．
合計 $A$ 本の辺を選ぶ方法の数は，
$$ [x^A] \bigl( F_{n_1}(x) \bigr)^{c_1} \bigl( F_{n_2}(x) \bigr)^{c_2} $$
と表せます．
よって，多項式 $\bigl( F_{n_1}(x) \bigr)^{c_1} \bigl( F_{n_2}(x) \bigr)^{c_2}$ を計算すればよいです．


### 計算量
+ $F_{n}(x)$ は，二項係数を前計算しておくことで $O(N)$ 時間で計算できます．
+ $\bigl( F_{n}(x) \bigr)^{c}$ は，[FPS の pow](https://judge.yosupo.jp/problem/pow_of_formal_power_series) を使うことで $O(N \log N)$ 時間で計算できます．
+ $2$ つの多項式を FFT で掛け合わせれば $O(N \log N)$ 時間です．

よって，全体で $O(N \log N)$ 時間です．

## 類題
[ABC214-G Three Permutations](https://atcoder.jp/contests/abc214/tasks/abc214_g) では，$n$ 頂点のサイクルにおけるサイズ $i$ のマッチングの個数が必要になります．

$1$ つの辺 $e$ に注目します．
* $e$ を選ばない場合，残った $n$ 頂点のパスグラフにおけるサイズ $i$ のマッチングは $\binom{n-i}{i}$ 通りです．
* $e$ を選ぶ場合，その両端の $2$ 辺は選べません．残った $(n-2)$ 頂点のパスグラフにおけるサイズ $(i-1)$ のマッチングは $\binom{(n-2) - (i-1)}{i-1} = \binom{n-i-1}{i-1}$ 通りです．

したがって， 全体で $\binom{n-i}{i} + \binom{n-i-1}{i-1}$ 通りです．
この問題ではサイクルのサイズが様々なので，時間計算量は $O(N (\log N)^2)$ です．

## 感想
個数系包除原理と FPS は相性がいいですね．
シンプルな問題設定ながら，FPS の典型テクも適用できる，教育的で面白い問題でした．
